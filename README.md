# 🐾 SaiPet

SillyTavern 채팅 화면에서 함께하는 **AI 반응형 가상 펫** 확장프로그램입니다.  
채팅을 관전하며 독자적인 감정 반응과 대사를 보여주고, 직접 말을 걸 수도 있습니다.

---

## ✨ 주요 기능

### 🎨 펫 외형 (12가지 감정 상태)
- **감정별 커스텀 이미지**: idle, happy, sad, excited, surprised, nervous, confident, shy, sleeping, thinking, angry, dragging
- **걷기 전용 스프라이트** 별도 설정 (파일 업로드 / URL)
- **GIF/WebP/SVG** 지원 (애니메이션 보존)
- 크기 조절 / 좌우 반전 / 투명도
- 이미지 미설정 시 기본 이모지 표시

### 🤖 AI 반응 시스템
- **관전자 모드**: 유저-AI 대화를 제3자 시점에서 관전하고 코멘트
- **캐릭터 모드 (속마음)**: 채팅 캐릭터의 진짜 속마음을 독백으로 표현
- **직접 말걸기 (💬)**: 펫에게 직접 대화를 걸면 성격에 맞게 응답
- **행동/감정 묘사**: AI가 짧은 행동 묘사를 자연스럽게 포함 (예: *피식*, (다가오며))
- **기분 자동 추론**: AI 응답에서 mood 태그를 파싱해 표정 자동 전환
- **generateRaw 사용**: ST 시스템 프롬프트 오염 없이 깨끗한 응답 생성
- **검열 방지 프리앰블** 자동 적용
- **월드인포(로어북) 포함 옵션**
- **Connection Manager 지원**: 별도 API 프로필로 펫 전용 API 사용 가능
- **채팅 히스토리 참조**: 최근 N개 메시지 참조 (1~20개 설정)
- **말투 언어 선택**: 한국어 / 영어 / 일본어 / 중국어

### 🐱🐱 멀티펫 시스템
- **2마리 동시 표시** — 프리셋에서 2번째 펫 불러오기
- **채팅 반응 분배**: 1번째만 / 2번째만 / 번갈아가며
- **듀얼 직접대화**: 말걸기 시 양쪽 펫이 1회 API 호출로 동시 반응
- **펫끼리 자동 대화**: 설정 간격마다 두 펫이 자동 대화 (로그 기록 + 기억)
- **펫 관계 설정**: 두 펫의 관계 (자매/라이벌/연인 등) → AI 프롬프트에 반영
- **펫 충돌 감지**: 겹치면 밀어내기 + 충돌 대사
- **2번째 펫 위치 프리셋** / **독립 컨디션** / **독립 걷기**

### 💬 말풍선
- **6종 디자인 테마**: 심플 / 귀여운 / 클래식 / 사이버펑크 / 레트로 / 오리엔탈
- **12종 한글 폰트** (ST-Customizer 호환)
- **배경색 / 글자색 / 액센트 컬러** 커스텀
- **최대 너비 슬라이더** / **표시 시간 설정**
- **화면 밖 잘림 방지**: 말풍선 자동 보정 + 꼬리 펫 중앙 지향

### 📝 커스텀 대사 (12가지 상황)
- idle, sleeping, dragging, click, clickSpam, greeting, latenight, morning, longAbsence, feeding, hungry, petting
- 각 상황별 여러 대사 등록 가능
- 미설정 시 기본 대사 사용

### 🍖 컨디션 시스템
- **배고픔 게이지**: 5분마다 자동 감소, 밥주기(🍖) 버튼으로 회복
- **배고픔 알림**: 30% 이하 시 자동 대사
- **오프라인 감소량 반영**
- **3단계 패널티**: ≤30% 배고픔 대사 오버라이드 / ≤10% 상호작용 50% 무시

### 🚶 걷기 시스템
- 좌우 이동 (±250px) + 뒤뚱 애니메이션
- 걷기 전용 스프라이트 지원
- 잠자기/드래그/ST 생성 중 자동 일시정지

### 💕 상호작용
- **쓰다듬기** (길게 누르기): 하트 파티클
- **연속 클릭** (5회+): 짜증 반응
- **졸기 이펙트**: sleeping 상태 `z z Z`
- 바운스 / 흔들림 애니메이션

### ⚡ 반응 트리거
- 유저 메시지 전송 / AI 응답 완료 / 대기 시간 초과
- **2단계 대기**: 5분 → idle 대사, 15분 → sleeping
- 시간대별 인사 (심야/아침) / 1시간+ 장기 부재 인사
- API 충돌 처리 (채팅 반응 15초 대기, 펫간 대화 30초 재시도)

### 🌙 꿈 시스템
- sleeping 상태에서 AI가 펫 성격 기반 꿈 + 잠꼬대 자동 생성
- 펫별 하루 횟수 제한
- 일기장에 자동 기록

### 📖 일기 시스템
- 당일 대화 기록 기반 AI 일기 작성
- **자동 일기**: 세션 30분+ & 채팅 N회+ 시 자동 생성
- **일기장 뷰어**: 전체화면 팝업 — 꿈/일기 탭, 펫별 필터, 페이지네이션, 삭제

### ⏰ 알림/리마인드
- **시각 지정 모드**: 특정 시간에 알림 (요일 선택)
- **반복 간격 모드**: N분마다 반복 알림 (10~240분)
- 펫 성격 기반 알림 대사 생성
- 알림 담당 펫 지정 가능

### 📝 개인 메모
- **태그 기반**: 메모 / 일정 / 건강 / 운동 / 기타
- **날짜 설정**: ±2일 이내 메모만 AI 프롬프트에 포함
- **반복 요일**: 일정/건강/운동/기타 태그에 요일별 반복 설정 (매주 자동 포함)
- **만료 메모 표시**: 날짜 지난 메모 흐리게 표시
- 내보내기 시 자동 제외 (개인정보 보호)

### 💾 프리셋 시스템
- 저장 / 불러오기 / 덮어쓰기 / 삭제
- JSON 내보내기/가져오기 (프리셋 공유)
- 개인정보 자동 제거 (ownerName, ownerPersona, personalMemos)

### 📊 대화 로그
- **직접 대화 로그**: 말걸기 → 펫 응답 (펫별 분리)
- **채팅 반응 로그**: AI 응답에 대한 펫 반응 (채팅방별)
- **펫끼리 대화 로그**: 자동 대화 기록 (이름 조합별)
- **알림 로그**: 리마인드/알림 대사 별도 기록 + 필터
- **펫별 로그 분리**: 직접 30건, 펫끼리 15건 한도
- 로그 뷰어 (필터: 전체/직접/반응/펫끼리/알림/현재 채팅방) / JSON 내보내기
- **말풍선 리플레이**: 놓친 대사를 로그에서 다시 말풍선으로 재생 (감정 표정 포함)

### 📱 모바일 대응
- 모바일/태블릿 감지 시 펫 자동 비활성화
- 터치 드래그 / 탭 / 길게 누르기 지원

---

## 📦 설치

1. SillyTavern `extensions/third-party/` 폴더에 `SaiPet` 폴더 복사
2. SillyTavern 재시작 또는 새로고침
3. 확장프로그램 설정에서 **🐾 SaiPet** 찾기

---

## 🎮 사용법

### 기본
1. **활성화** 토글 ON
2. 채팅하면서 펫 반응 즐기기

### AI 반응
1. **AI 반응 사용** ON → 펫 이름 설정
2. (선택) 커스텀 성격 프롬프트 작성
3. (선택) 반응 모드: 관전자 / 캐릭터(속마음)
4. (선택) Connection Manager 프로필 연결

### 멀티펫
1. **멀티펫 사용** ON → 프리셋에서 2번째 펫 불러오기
2. 채팅 반응 분배 설정
3. (선택) 듀얼 직접대화 / 펫끼리 자동 대화 ON

### 알림
1. 모드 선택: **시각 지정** 또는 **반복 간격**
2. 메시지 입력 → 요일/간격 설정 → **알림 추가**

### 꿈 & 일기
1. 꿈/일기 각각 토글
2. (선택) 자동 일기 ON + 최소 대화 횟수 설정
3. **📖 일기장 열어보기**로 열람

---

## 😺 상태 목록

| 상태 | 설명 | 기본 이모지 |
|------|------|-------------|
| idle | 평상시 | 😺 |
| happy | 기쁨 | 😸 |
| sad | 슬픔 | 😿 |
| excited | 흥분 | 🙀 |
| surprised | 놀람 | 🙀 |
| nervous | 긴장 | 😾 |
| confident | 자신감 | 😼 |
| shy | 수줍음 | 🙈 |
| sleeping | 잠자기 | 😴 |
| thinking | 생각중 | 🐱 |
| angry | 화남 | 😾 |
| dragging | 드래그 | 😼 |

---

## 🎨 말풍선 디자인

| 디자인 | 설명 |
|--------|------|
| simple | 깔끔한 기본 스타일 |
| cute | 둥글둥글 귀여운 스타일 |
| classic | 전통 RPG 말풍선 |
| cyberpunk | 네온/글리치 사이버펑크 |
| retro | 도트/픽셀 레트로 게임풍 |
| oriental | 동양풍 수묵/한지 스타일 |

---

## 🔧 기술 스택

- Vanilla JavaScript (ES Modules)
- CSS3 Animations & CSS Variables
- FontAwesome Icons
- SillyTavern Extension API (`generateRaw`, `eventSource`, `getContext`)
- Connection Manager API (선택)

---

## 📝 버전 기록

### v1.3.0
**신규 기능**
- 🌙 **꿈 시스템**: sleeping 상태에서 AI 기반 꿈 + 잠꼬대 자동 생성
- 📖 **일기 시스템**: 대화 기록 기반 AI 일기 + 자동 일기 + 일기장 뷰어 (팝업)
- ⏰ **알림/리마인드**: 시각 지정 / 반복 간격 모드, 요일 선택, 토글 버튼 UI
- 📝 **개인 메모**: 태그 기반 (메모/일정/건강/운동/기타) + 날짜 + 반복 요일 설정
- 💕 **멀티펫 관계 설정**: 두 펫의 관계를 AI 프롬프트에 반영
- 🧠 **상황 컨텍스트**: 현재 시간·배고픔·마지막 상호작용을 모든 프롬프트에 삽입
- 📋 **알림 로그**: 리마인드/알림 대사를 별도 로그로 기록, 필터 분리
- 🔁 **말풍선 리플레이**: 놓친 대사를 로그에서 다시 말풍선으로 재생 (감정 표정 포함)
- 🎭 **행동/감정 묘사**: AI 대사에 짧은 감정/행동 묘사 허용 (예: *피식*, (다가오며))

**개선**
- 🎨 CSS 전면 리디자인: 파스텔/미니멀, 불투명 고정색 (다크 테마 호환)
- 🎨 컬러 시스템 통일: 블루(메인) + 핑크/라벤더(보조) + 민트(기능) 4색 팔레트
- 🎨 반응형 스프라이트 그리드 (auto-fill, 좁은 화면 대응)
- 🎨 버튼 스타일 통일 (flexbox 아이콘+텍스트 정렬)
- 🎨 섹션별 아이콘 컬러 / 로그·일기장 가독성 개선
- 📊 펫별 로그 분리 (직접 30건, 펫끼리 15건)
- 🔄 프롬프트 개선: 1-3문장, 250자 한도, 로그 반복 방지 강화
- ⏱️ 대기 시간 조정: idle 5분, sleeping 15분
- 🔧 GIF/WebP 애니메이션 보존, SVG 지원
- 🔧 리사이즈 디바운스, 타이머/핸들러 메모리 누수 방지

**삭제**
- ❌ 자발적 말걸기 (Gemini API 검열 이슈)
- ❌ 선물 시스템 (미완성 기능 정리)
- ❌ 테스트 버튼 (개발용)

**버그 수정**
- 🐛 드래그 이동 OFF 시 클릭/쓰다듬기 미작동
- 🐛 자동 일기 `sessionElapsed` 미정의 크래시
- 🐛 2번째 펫 해제 시 click 리스너 누적 누수
- 🐛 펫간 대화 retry setTimeout 중첩 + 최소 간격 3분
- 🐛 `maxTokens` 슬라이더 최대값 200 → 4096
- 🐛 직접 대화 후에도 펫이 잠드는 문제 (수면 타이머 미리셋)

**성능 개선**
- ⚡ 걷기/충돌 시 불필요한 설정 저장 제거 (직렬화 부하 감소)
- ⚡ 스프라이트 캐싱: 같은 이미지일 때 DOM 교체 생략 (GIF 재시작 방지)
- ⚡ 말풍선 위치 보정 레이아웃 스래싱 수정

### v1.2.0
- 🐱🐱 멀티펫 시스템 (2마리 동시, 독립 상호작용/컨디션/걷기)
- 채팅 반응 분배 / 듀얼 직접대화 / 펫끼리 자동 대화
- 펫 충돌 감지 + 충돌 대사
- 말투 언어 선택 (한/영/일/중)
- API 충돌 처리 (대기 + 재시도)
- UI 탭 구조 개편

### v1.1.0
- 걷기 시스템 (뒤뚱 애니메이션, 워킹 스프라이트)
- 3단계 배고픔 패널티
- 6종 말풍선 테마 + 12종 폰트
- 2단계 대기 시스템

### v1.0.0
- 최초 릴리즈
- 12상태 스프라이트 + AI 반응 + 직접 말걸기
- 컨디션 시스템 + 프리셋 + 상호작용 이펙트

---

## 📄 라이선스

MIT License
